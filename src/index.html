<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Google Charts -->
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
    <style>
      /* Simple loader */
      #loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 2s linear infinite;
        position: absolute;
        top: 40%;
        left: 45%;
      }
      #loader-text {
        position: absolute;
        top: 50%;
        left: 40%;
        margin-top: 50px;
        color: #333;
        font-family: sans-serif;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans p-4 sm:p-8">
    <div id="loader-container">
      <div id="loader"></div>
      <div id="loader-text">Loading data...</div>
    </div>

    <div id="app-content" class="max-w-7xl mx-auto hidden">
      <!-- Header -->
      <h1 class="text-3xl font-bold text-gray-800 mb-6">
        Library Complexity Dashboard
      </h1>

      <!-- Top Row: Prediction & Time Series -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Prediction Panel -->
        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">
            Make a Prediction
          </h2>
          <p class="text-sm text-gray-600 mb-4">
            Select the conditions to predict the library's status based on
            historical data.
          </p>

          <div class="space-y-4">
            <!-- --- UPDATED: Removed Floor and Location, added Combined Location --- -->
            <div>
              <label
                for="filter-combined-location"
                class="block text-sm font-medium text-gray-700"
                >Location (Floor)</label
              >
              <select
                id="filter-combined-location"
                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
              ></select>
            </div>
            <div>
              <label
                for="filter-day"
                class="block text-sm font-medium text-gray-700"
                >Day of Week</label
              >
              <select
                id="filter-day"
                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
              ></select>
            </div>
            <div>
              <label
                for="filter-hour"
                class="block text-sm font-medium text-gray-700"
                >Hour (24-hour)</label
              >
              <select
                id="filter-hour"
                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
              ></select>
            </div>
          </div>

          <button
            id="predict-button"
            class="mt-6 w-full bg-indigo-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            Predict Status
          </button>

          <div
            id="prediction-result"
            class="mt-6 p-4 bg-gray-50 rounded-md hidden"
          >
            <h3 class="text-lg font-semibold text-gray-800">Prediction:</h3>
            <p id="result-text" class="text-xl text-center font-bold"></p>
            <p
              id="result-subtext"
              class="text-sm text-center text-gray-600"
            ></p>
          </div>
        </div>

        <!-- Time Series Analysis Panel -->
        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">
            Time Series Analysis: Average Complexity by Hour
          </h2>
          <p class="text-sm text-gray-600 mb-4">
            This line chart shows the overall library "rhythm." It's the average
            percentage of locations marked "Moderate" (보통) or "Congested"
            (혼잡) at any given hour.
          </p>
          <!-- THIS IS THE CHANGE -->
          <div id="timeseries-chart-div" class="w-full h-[32rem]"></div>
          <p id="timeseries-chart-error" class="text-red-500 hidden"></p>
        </div>
      </div>

      <!-- Bottom Row: Bar Chart -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">
          Historical Status by Location
        </h2>
        <p class="text-sm text-gray-600 mb-4">
          This chart shows the total counts of all three statuses recorded for
          each location.
        </p>
        <!-- THIS IS THE CHANGE -->
        <div id="barchart-div" class="w-full h-[32rem]"></div>
        <p id="barchart-error" class="text-red-500 hidden"></p>
      </div>
    </div>

    <script>
      let globalData = null;

      google.charts.load("current", { packages: ["corechart", "bar"] });
      google.charts.setOnLoadCallback(loadData);

      function loadData() {
        console.log("Requesting data from server...");
        google.script.run
          .withSuccessHandler(onDataLoaded)
          .withFailureHandler(onFailure)
          .getSheetData();
      }

      function onDataLoaded(data) {
        console.log("Data received from server:", data);

        if (data.error) {
          onFailure({ message: data.error });
          return;
        }

        if (!data.filters || data.filters.floors.length === 0) {
          onFailure({
            message:
              "No data was processed. Please check your spreadsheet data format and Apps Script logs for errors.",
          });
          return;
        }

        globalData = data;

        // Populate filter dropdowns
        // --- UPDATED ---
        populateSelect(
          "filter-combined-location",
          data.filters.combinedLocations
        );
        populateSelect("filter-day", data.filters.days);

        const formattedHours = data.filters.hours.map((h) => {
          const hourStr = String(h).padStart(2, "0");
          return { value: h, text: `${hourStr}:00` };
        });
        populateSelect("filter-hour", formattedHours, true);

        // Draw the charts
        drawBarChart(data.barChartData);
        drawTimeSeriesChart(data.timeSeriesChartData);

        document.getElementById("loader-container").classList.add("hidden");
        document.getElementById("app-content").classList.remove("hidden");
        document
          .getElementById("predict-button")
          .addEventListener("click", handlePrediction);
      }

      function populateSelect(elementId, options, isObject = false) {
        const select = document.getElementById(elementId);
        select.innerHTML = "";

        if (options.length === 0) {
          select.innerHTML = "<option>No options</option>";
          return;
        }

        options.forEach((option) => {
          const opt = document.createElement("option");
          if (isObject) {
            opt.value = option.value;
            opt.textContent = option.text;
          } else {
            opt.value = option;
            opt.textContent = option;
          }
          select.appendChild(opt);
        });
      }

      /**
       * Draws the Bar Chart with 3 statuses
       */
      function drawBarChart(chartData) {
        if (!chartData || chartData.length <= 1) {
          document.getElementById("barchart-error").textContent =
            "No data for Bar Chart.";
          document.getElementById("barchart-error").classList.remove("hidden");
          return;
        }

        const data = google.visualization.arrayToDataTable(chartData);
        const options = {
          title: "Status Counts by Location",
          chartArea: { width: "60%" },
          isStacked: true,
          hAxis: { title: "Total Count", minValue: 0 },
          // --- UPDATED ---
          vAxis: { title: "Location (Floor)" },
          // Colors for Smooth (Green), Moderate (Amber), Congested (Red)
          colors: ["#6EE7B7", "#FBBF24", "#EF4444"],
        };
        const chart = new google.visualization.BarChart(
          document.getElementById("barchart-div")
        );
        chart.draw(data, options);
      }

      /**
       * Draws the Time Series Line Chart
       */
      function drawTimeSeriesChart(chartData) {
        if (!chartData || chartData.length <= 1) {
          document.getElementById("timeseries-chart-error").textContent =
            "No data for Time Series Chart.";
          document
            .getElementById("timeseries-chart-error")
            .classList.remove("hidden");
          return;
        }

        const data = google.visualization.arrayToDataTable(chartData);
        const options = {
          title: "Average Library Complexity by Hour",
          hAxis: { title: "Hour of Day" },
          vAxis: {
            title: "Not Smooth % (Mod/Congested)",
            minValue: 0,
            maxValue: 100,
            format: "#'%'",
          },
          legend: { position: "none" },
          colors: ["#4F46E5"], // Indigo-600
        };
        const chart = new google.visualization.LineChart(
          document.getElementById("timeseries-chart-div")
        );
        chart.draw(data, options);
      }

      /**
       * Handles the prediction logic (now finds the max of 3 statuses)
       */
      function handlePrediction() {
        // --- UPDATED ---
        const combinedLocation = document.getElementById(
          "filter-combined-location"
        ).value;
        const day = document.getElementById("filter-day").value;
        const hour = document.getElementById("filter-hour").value;

        // Parse the combinedLocation string back into its parts
        // Uses regex to capture "Location Name" and "Floor"
        // e.g., "어린이자료실 (1F)" -> location="어린이자료실", floor="1F"
        const regex = /(.+) \((.+)\)$/;
        const match = combinedLocation.match(regex);

        const resultDiv = document.getElementById("prediction-result");
        const resultText = document.getElementById("result-text");
        const resultSubtext = document.getElementById("result-subtext");

        if (!match) {
          resultText.textContent = "Error";
          resultText.className = "text-xl text-center font-bold text-red-600";
          resultSubtext.textContent =
            "Could not parse location. Please try again.";
          resultDiv.classList.remove("hidden");
          console.error("Could not parse combinedLocation:", combinedLocation);
          return;
        }

        const location = match[1];
        const floor = match[2];
        // --- END UPDATE ---

        const modelKey = `${floor}|${location}|${day}|${hour}`;

        if (!globalData || !globalData.predictionModel) {
          onFailure({ message: "Prediction model not loaded." });
          return;
        }

        const modelEntry = globalData.predictionModel[modelKey];

        if (modelEntry) {
          // Find the status with the highest count
          const statuses = [
            {
              name: "혼잡 (Congested)",
              count: modelEntry["혼잡"],
              color: "text-red-600",
            },
            {
              name: "보통 (Moderate)",
              count: modelEntry["보통"],
              color: "text-yellow-600",
            },
            {
              name: "원활 (Smooth)",
              count: modelEntry["원활"],
              color: "text-green-600",
            },
          ];

          // Sort to find the highest
          statuses.sort((a, b) => b.count - a.count);
          const bestPrediction = statuses[0];

          const probability = (bestPrediction.count / modelEntry.total) * 100;

          resultText.textContent = bestPrediction.name;
          resultText.className = `text-xl text-center font-bold ${bestPrediction.color}`;
          resultSubtext.textContent = `Based on ${
            modelEntry.total
          } data points, there's a ${Math.round(
            probability
          )}% chance of this status.`;
        } else {
          resultText.textContent = "No Data";
          resultText.className = "text-xl text-center font-bold text-gray-500";
          resultSubtext.textContent =
            "We have no historical data for this specific combination.";
        }

        resultDiv.classList.remove("hidden");
      }

      function onFailure(error) {
        console.error("Failed to load:", error);
        const loaderContainer = document.getElementById("loader-container");
        loaderContainer.innerHTML = `<div class="text-red-600 font-bold p-8 bg-white rounded shadow-md">Error: ${error.message}. <br><br>Please check the following: <br>1. The spreadsheet name is exactly 'SJCityLib'. <br>2. The sheet name is exactly 'Complexity'. <br>3. Check the Apps Script "Executions" log for more details.</div>`;
      }
    </script>
  </body>
</html>
